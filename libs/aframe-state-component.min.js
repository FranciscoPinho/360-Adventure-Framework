!function(t,e){if("object"==typeof exports&&"object"==typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var i=e();for(var s in i)("object"==typeof exports?exports:t)[s]=i[s]}}("undefined"!=typeof self?self:this,function(){return function(t){function e(s){if(i[s])return i[s].exports;var n=i[s]={i:s,l:!1,exports:{}};return t[s].call(n.exports,n,n.exports,e),n.l=!0,n.exports}var i={};return e.m=t,e.c=i,e.d=function(t,i,s){e.o(t,i)||Object.defineProperty(t,i,{configurable:!1,enumerable:!0,get:s})},e.n=function(t){var i=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(i,"a",i),i},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=0)}([function(t,e,i){"use strict";function s(t,e,i,s){var r,o,a,h,d,u;if(u=c(e,/\s+/),1===u.length)return n(t,e,i,s);for(E.length=0,f(S,u),a=0;a<S.length;a++)-1!==A.indexOf(S[a])?(o=n(t,E.pop()),d=S[a+1].replace(v,""),r=-1===S[a].indexOf("!")?o===d:o!==d,E.push(r),a++):E.push(S[a]);if(1===E.length)return E[0];for(h=E[0].constructor===Boolean?E[0]:n(t,E[0],i,s),a=1;a<E.length;a+=2)E[a]!==g&&E[a]!==m||(E[a+1]=E[a+1].constructor===Boolean?E[a+1]:n(t,E[a+1]),E[a]===g?h=h||E[a+1]:E[a]===m&&(h=h&&E[a+1]));return h}function n(t,e,i,s){var r,o,a,h;for(i&&e.startsWith(i.for)&&(o=e,e=i.in),h=t,a=c(u(e),"."),r=0;r<a.length;r++)r<a.length-1&&!(a[r]in h)&&console.error("[state] Not found:",a,a[r]),h=h[a[r]];if(i){if(!i.key)return h[s];for(r=0;r<h.length;r++)if(h[r][i.key]===s){h=n(h[r],o.replace(i.for+".",""));break}}return"!"===e[0]&&"!"===e[1]?!!h:"!"===e[0]?!h:h}function r(t){for(var e in t)delete t[e]}function o(){var t,e,i,s=arguments;for(i={},e=0;e<s.length;e++)for(t in s[e])t in i?i[t].constructor===Array?i[t].push(s[e][t]):i[t]=[i[t],s[e][t]]:i[t]=s[e][t];for(t in i)i[t].constructor===Array&&(i[t]=a.apply(this,i[t]));return i}function a(){var t=arguments;return function(){var e;for(e=0;e<t.length;e++)t[e].apply(this,arguments)}}function h(t,e){var i,s;for(s=e.split(/\s+/),i=0;i<s.length;i++)-1!==x.indexOf(s[i])||s[i].startsWith("'")||-1!==t.indexOf(s[i])||t.push(d(s[i]))}function d(t){var e;return t=u(t.trim()),e=t.indexOf("."),-1===e?t:t.substring(0,t.indexOf("."))}function u(t){return 0===t.indexOf("!!")?t.replace("!!",""):0===t.indexOf("!")?t.replace("!",""):t}function c(t,e){return F[e]||(F[e]={}),F[e][t]?F[e][t]:(F[e][t]=t.split(e),F[e][t])}function f(t,e){var i;for(t.length=0,i=0;i<e.length;i++)t[i]=e[i]}var l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},p=i(1),y=i(2).wrapArray,b={initialState:{},nonBindedStateKeys:[],handlers:{},computeState:function(){}};AFRAME.registerState=function(t){AFRAME.utils.extend(b,t)},AFRAME.registerSystem("state",{init:function(){var t,e=this;this.diff={},this.state=AFRAME.utils.clone(b.initialState),this.subscriptions=[],this.initEventHandlers();for(t in this.state)this.state[t]&&this.state[t].constructor===Array&&(this.state[t].__dirty=!0,y(this.state[t]));this.lastState=AFRAME.utils.clone(this.state),this.eventDetail={lastState:this.lastState,state:this.state},this.el.addEventListener("loaded",function(){var t;for(b.computeState(e.state,"@@INIT"),t=0;t<e.subscriptions.length;t++)e.subscriptions[t].onStateUpdate(e.state)})},dispatch:function(t,e){var i,s;b.handlers[t](this.state,e),b.computeState(this.state,t,e);for(s in this.diff)delete this.diff[s];for(p(this.lastState,this.state,this.diff,b.nonBindedStateKeys),i=0;i<this.subscriptions.length;i++){if("bind-for"===this.subscriptions[i].name){if(!this.state[this.subscriptions[i].keysToWatch[0]].__dirty)continue}else if(!this.shouldUpdate(this.subscriptions[i].keysToWatch,this.diff))continue;this.subscriptions[i].onStateUpdate()}for(s in this.state)this.state[s]&&this.state[s].constructor===Array&&(this.state[s].__dirty=!1);this.copyState(this.lastState,this.state),this.eventDetail.action=t,this.eventDetail.payload=e,this.el.emit("stateupdate",this.eventDetail)},copyState:function(t,e,i){var s;for(s in e)if(i||-1===b.nonBindedStateKeys.indexOf(s))if(e[s]&&e[s].constructor===Object){if(!(s in t)){t[s]=AFRAME.utils.clone(e[s]);continue}this.copyState(t[s],e[s],!0)}else t[s]=e[s]},subscribe:function(t){this.subscriptions.push(t)},unsubscribe:function(t){this.subscriptions.splice(this.subscriptions.indexOf(t),1)},shouldUpdate:function(t,e){var i;for(i in e)if(-1!==t.indexOf(i))return!0;return!1},initEventHandlers:function(){function t(t){var e=this;this.el.addEventListener(t,function(i){e.dispatch(t,i.detail)})}var e,i=[];t=t.bind(this);for(e in b.handlers)-1===i.indexOf(e)&&(i.push(e),t(e))},renderTemplate:function(){var t=/{{\s*(\w*\.)?([\w.]+)\s*}}/g;return function(e,i,n){var r,o;for(o=e;r=t.exec(e);)o=o.replace(r[0],"object"===(void 0===i?"undefined":l(i))?s(i,r[2])||"":i);return n?o:document.createRange().createContextualFragment(o)}}(),select:s}),AFRAME.registerComponent("bind",{schema:{default:{},parse:function(t){var e,i,s,n;if(t.constructor===Object)return t;if(-1===t.indexOf(":"))return t;for(e={},s=c(t,";"),i=0;i<s.length;i++)n=c(s[i].trim(),":"),e[n[0]]=n[1].trim();return e}},multiple:!0,init:function(){this.data;this.keysToWatch=[],this.onStateUpdate=this.onStateUpdate.bind(this),this.system=this.el.sceneEl.systems.state,this.isNamespacedBind=this.id&&this.id in AFRAME.components&&!AFRAME.components[this.id].isSingleProp||this.id in AFRAME.systems,this.lastData={},this.updateObj={},this.system.subscribe(this),this.onStateUpdate=this.onStateUpdate.bind(this)},update:function(){var t,e,i=this.data;if(this.keysToWatch.length=0,"string"==typeof i)h(this.keysToWatch,i);else for(e in i)h(this.keysToWatch,i[e]);t=this.el.closest("[bind-for]"),t&&t!==this.el?(this.bindForEl=t,this.bindRootEl=this.el.closest("[data-bind-for-key]"),this.bindFor=this.bindForEl.getAttribute("bind-for"),this.bindForKey=this.bindRootEl.getAttribute("data-bind-for-key"),this.keysToWatch.push(this.bindFor.in),this.bindForEl.addEventListener("bindforrender",this.onStateUpdate)):(this.bindFor="",this.bindForKey=""),this.onStateUpdate()},onStateUpdate:function(){var t,e,i,n,o=!1,a=this.el;if(a.parentNode){if(this.isNamespacedBind&&r(this.updateObj),i=this.system.state,"object"!==l(this.data)){try{n=s(i,this.data,this.bindFor,this.bindForKey)}catch(t){throw new Error("[aframe-state-component] Key '"+this.data+"' not found in state. #"+this.el.getAttribute("id")+"["+this.attrName+"]")}if("object"!==(void 0===n?"undefined":l(n))&&"object"!==l(this.lastData)&&this.lastData===n)return;return AFRAME.utils.entity.setComponentProperty(a,this.id,n),void(this.lastData=n)}for(t in this.data){e=this.data[t].trim();try{if(n=s(i,e,this.bindFor,this.bindForKey),this.bindFor&&void 0===n)return}catch(t){throw new Error("[aframe-state-component] Key '"+e+"' not found in state. #"+this.el.getAttribute("id")+"["+this.attrName+"]")}if("object"===(void 0===n?"undefined":l(n))||"object"===l(this.lastData[t])||this.lastData[t]!==n){if(t in AFRAME.components&&void 0===n)return void a.removeAttribute(t);this.isNamespacedBind?this.updateObj[t]=n:AFRAME.utils.entity.setComponentProperty(a,t,n),this.lastData[t]=n}}for(o in this.updateObj);this.isNamespacedBind&&o&&a.setAttribute(this.id,this.updateObj)}},remove:function(){this.system.unsubscribe(this),this.bindForEl&&this.bindForEl.removeEventListener("bindforrender",this.onStateUpdate)}}),AFRAME.registerComponent("bind-toggle",{schema:{type:"string"},multiple:!0,init:function(){this.system=this.el.sceneEl.systems.state,this.keysToWatch=[],this.onStateUpdate=this.onStateUpdate.bind(this),this.system.subscribe(this),this.onStateUpdate()},update:function(){this.keysToWatch.length=0,h(this.keysToWatch,this.data)},onStateUpdate:function(){var t,e,i=this.el;t=this.system.state;try{e=s(t,this.data)}catch(t){throw new Error("[aframe-state-component] Key '"+this.data+"' not found in state. #"+this.el.getAttribute("id")+"["+this.attrName+"]")}e?i.setAttribute(this.id,""):i.removeAttribute(this.id)},remove:function(){this.system.unsubscribe(this)}}),AFRAME.registerComponent("bind-for",{schema:{for:{type:"string"},in:{type:"string"},key:{type:"string"},template:{type:"string"}},init:function(){this.system=this.el.sceneEl.systems.state,this.onStateUpdate=this.onStateUpdate.bind(this),this.keysToWatch=[],this.renderedKeys=[],this.system.subscribe(this)},update:function(){this.keysToWatch[0]=c(this.data.in,".")[0],this.el.children[0]&&"TEMPLATE"===this.el.children[0].tagName?this.template=this.el.children[0].innerHTML.trim():this.template=document.querySelector(this.data.template).innerHTML.trim(),this.onStateUpdate()},onStateUpdate:function(){var t=[],e=[];return function(){var i,n,r,o,a=this.data,h=this.el;try{n=s(this.system.state,a.in)}catch(t){throw new Error("[aframe-state-component] Key '"+a.in+"' not found in state. #"+h.getAttribute("id")+"["+this.attrName+"]")}for(t.length=0,i=0;i<n.length;i++){var d;o=n[i],d=a.key?o[a.key]:i.toString(),t.push(d),-1!==this.renderedKeys.indexOf(d)||(h.appendChild(this.system.renderTemplate(this.template,o)),h.children[h.children.length-1].setAttribute("data-bind-for-key",d),this.renderedKeys.push(d))}for(e.length=0,i=0;i<h.children.length;i++)"TEMPLATE"!==h.children[i].tagName&&(r=h.children[i].getAttribute("data-bind-for-key"),-1===t.indexOf(r)&&(e.push(h.children[i]),this.renderedKeys.splice(this.renderedKeys.indexOf(r),1)));for(i=0;i<e.length;i++)e[i].parentNode.removeChild(e[i]);this.el.emit("bindforrender",null,!1)}}()});var m="&&",v=/'/g,g="||",A=["==","===","!=","!=="],S=[],E=[];t.exports.composeHandlers=o,t.exports.composeFunctions=a;var x=["||","&&","!=","!==","==","==="],F={}},function(t,e,i){"use strict";t.exports=function(){var t=[];return function(e,i,s,n){var r,o,a,h,d,u,c;h=s||{},t.length=0;for(d in e)t.push(d);if(!i)return h;for(a in i)-1===t.indexOf(a)&&t.push(a);for(u=0;u<t.length;u++)d=t[u],n&&-1!==n.indexOf(d)||(r=e[d],o=i[d],((c=r&&o&&r.constructor===Object&&o.constructor===Object)&&!AFRAME.utils.deepEqual(r,o)||!c&&r!==o)&&(h[d]=o));return h}}()},function(t,e,i){"use strict";function s(t){var e;if(!t.__wrapped){for(e=0;e<r.length;e++)n(t,r[e]);t.__wrapped=!0}}function n(t,e){var i=t[e];t[e]=function(){i.apply(t,arguments),t.__dirty=!0}}var r=["push","pop","shift","unshift","splice"];t.exports.wrapArray=s}])});